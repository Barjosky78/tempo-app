name: Update Tempo + History + Stats + ML (Hourly Stable FINAL)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: pip install pandas scikit-learn joblib

      # ======================
      # FETCH EDF
      # ======================
      - name: Fetch EDF Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > edf_tempo.json || echo '{}' > edf_tempo.json

      # ======================
      # FETCH WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # FETCH RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD TEMPO.JSON (FIX J0/J1 DÃ‰FINITIF)
      # ======================
      - name: Build tempo.json
        run: |
          node <<'EOF'
          const fs = require("fs");

          const fmt = d => d.toISOString().split("T")[0];

          // ðŸ‡«ðŸ‡· DATE FRANCE
          const now = new Date(
            new Date().toLocaleString("en-US", { timeZone: "Europe/Paris" })
          );
          now.setHours(0,0,0,0);
          const today = new Date(now);

          let edf = {};
          try { edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8")); } catch {}

          const edfToday    = edf.today ?? edf.aujourd_hui ?? edf.jourJ ?? null;
          const edfTomorrow = edf.tomorrow ?? edf.demain ?? null;

          let temps = [];
          try {
            temps = JSON.parse(fs.readFileSync("weather.json","utf8"))
              .daily?.temperature_2m_mean || [];
          } catch {}

          let consommation = null;
          let tension = 60;
          try {
            consommation = JSON.parse(fs.readFileSync("rte.json","utf8"))
              .records?.[0]?.fields?.consommation ?? null;
          } catch {}

          const HISTO_MONTH = {
            11:{rouge:8,blanc:22,bleu:70},
            12:{rouge:14,blanc:30,bleu:56},
            1:{rouge:20,blanc:34,bleu:46},
            2:{rouge:17,blanc:33,bleu:50},
            3:{rouge:4,blanc:22,bleu:74}
          };

          const days = [];

          function buildEstimate(date, idx) {
            let base = HISTO_MONTH[date.getMonth()+1] || {rouge:10,blanc:25,bleu:65};
            let rouge=base.rouge, blanc=base.blanc, bleu=base.bleu;

            const temp = temps[idx] ?? 8;
            if (temp < 3) { blanc+=8; bleu-=4; }
            if (temp < 0) { rouge+=6; bleu-=4; }

            const total = rouge+blanc+bleu;
            rouge=Math.round(rouge/total*100);
            blanc=Math.round(blanc/total*100);
            bleu=100-rouge-blanc;

            let couleur="bleu";
            if (rouge>blanc&&rouge>bleu) couleur="rouge";
            else if (blanc>=bleu) couleur="blanc";

            return { couleur, probabilites:{rouge,blanc,bleu} };
          }

          // ========= J0 (TOUJOURS)
          const j0 = buildEstimate(today,0);
          days.push({
            date: fmt(today),
            couleur: edfToday ?? j0.couleur,
            probabilites: edfToday
              ? { rouge:0, blanc:0, bleu:0, [edfToday]:100 }
              : j0.probabilites,
            fixed: Boolean(edfToday),
            sources: edfToday ? {reel:true} : {historique:true,meteo:true}
          });

          // ========= J1 (TOUJOURS)
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate()+1);
          const j1 = buildEstimate(tomorrow,1);

          days.push({
            date: fmt(tomorrow),
            couleur: edfTomorrow ?? j1.couleur,
            probabilites: edfTomorrow
              ? { rouge:0, blanc:0, bleu:0, [edfTomorrow]:100 }
              : j1.probabilites,
            fixed: Boolean(edfTomorrow),
            sources: edfTomorrow ? {reel:true} : {historique:true,meteo:true}
          });

          // ========= J2 â†’ J9
          for (let i=2;i<=9;i++) {
            const d=new Date(today);
            d.setDate(today.getDate()+i);
            const est = buildEstimate(d,i);

            days.push({
              date: fmt(d),
              couleur: est.couleur,
              probabilites: est.probabilites,
              fixed:false,
              temperature: temps[i] ?? null,
              rteConsommation: consommation,
              sources:{historique:true,meteo:true,rte:consommation!==null}
            });
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
          fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_tempo.json
          git commit -m "Fix J0/J1 EDF â€” no missing days, safe fallback" || echo "No changes"
          git push
