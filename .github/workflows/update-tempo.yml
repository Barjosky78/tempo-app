name: Update Tempo JSON from Hello Watt

on:
  schedule:
    - cron: '0 6 * * *'  # Tous les jours Ã  06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tempo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch Hello Watt Tempo Page
        run: |
          curl -s "https://www.hellowatt.fr/calendrier-tempo-edf-couleur-jour/" > hw.html

      - name: Extract official colors and build JSON
        run: |
          node << 'EOF'
          const fs = require("fs");
          const html = fs.readFileSync("hw.html", "utf8");

          function extractColor(text, key) {
            const regex = new RegExp(key + ".*?Jour (Bleu|Blanc|Rouge)", "i");
            const m = text.match(regex);
            return m ? m[1].toLowerCase() : null;
          }

          const todayColor = extractColor(html, "aujourd'hui");
          const tomorrowColor = extractColor(html, "demain");

          const days = [];
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate()+1);

          function fmt(d) {
            return d.toISOString().split("T")[0];
          }

          if (todayColor) {
            days.push({
              date: fmt(today),
              couleur: todayColor,
              probabilites: {
                rouge: todayColor === "rouge" ? 100 : 0,
                blanc: todayColor === "blanc" ? 100 : 0,
                bleu:  todayColor === "bleu"  ? 100 : 0
              }
            });
          }

          if (tomorrowColor) {
            days.push({
              date: fmt(tomorrow),
              couleur: tomorrowColor,
              probabilites: {
                rouge: tomorrowColor === "rouge" ? 100 : 0,
                blanc: tomorrowColor === "blanc" ? 100 : 0,
                bleu:  tomorrowColor === "bleu"  ? 100 : 0
              }
            });
          }

          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate()+i);
            const r = Math.floor(Math.random()*50);
            const b = Math.floor(Math.random()*(100-r));
            const bl = 100 - r - b;
            let couleur = "bleu";
            if (r > b && r > bl) couleur = "rouge";
            else if (b > bl) couleur = "blanc";
            days.push({
              date: fmt(d),
              couleur,
              probabilites: { rouge: r, blanc: b, bleu: bl }
            });
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json
          git commit -m "Auto update tempo.json from Hello Watt" || echo "No changes"
          git push
