name: Update Tempo + History + Stats + ML (Hourly)

on:
  schedule:
    - cron: '0 * * * *'   # â±ï¸ Toutes les heures (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ======================
      # PYTHON (ML)
      # ======================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install scikit-learn joblib pandas

      # ======================
      # EDF TEMPO OFFICIEL
      # ======================
      - name: Fetch official EDF Tempo
        run: |
          echo "âš¡ Fetch EDF Tempo"
          curl -s https://www.api-couleur-tempo.fr/api \
            > edf_tempo.json || echo '{}' > edf_tempo.json

      # ======================
      # MÃ‰TÃ‰O
      # ======================
      - name: Fetch Weather
        run: |
          echo "ðŸŒ¦ï¸ Fetch Weather"
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
            | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE consumption
        run: |
          echo "âš¡ Fetch RTE"
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
            | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD TEMPO.JSON
      # ======================
      - name: Build tempo data
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          /* ======================
             EDF OFFICIEL (ROBUSTE)
          ====================== */
          let edf = {};
          try { edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8")); } catch {}

          const edfToday =
            edf.today ??
            edf.aujourd_hui ??
            edf.jourJ ??
            "bleu";

          const edfTomorrow =
            edf.tomorrow ??
            edf.demain ??
            edf.jourJ1 ??
            edf.j1 ??
            null;

          /* ======================
             WEATHER
          ====================== */
          let temps = [];
          try {
            const w = JSON.parse(fs.readFileSync("weather.json","utf8"));
            temps = w.daily?.temperature_2m_mean || [];
          } catch {}

          /* ======================
             RTE
          ====================== */
          let consommation = null;
          let tension = 60;
          try {
            const r = JSON.parse(fs.readFileSync("rte.json","utf8"));
            consommation = r.records?.[0]?.fields?.consommation ?? null;
            if (consommation !== null) {
              if (consommation < 45000) tension = 50;
              else if (consommation < 55000) tension = 60;
              else if (consommation < 65000) tension = 70;
              else tension = 80;
            }
          } catch {}

          /* ======================
             HISTO BASE
          ====================== */
          const HISTO_MONTH = {
            11:{rouge:8,blanc:22,bleu:70},
            12:{rouge:14,blanc:30,bleu:56},
            1:{rouge:20,blanc:34,bleu:46},
            2:{rouge:17,blanc:33,bleu:50},
            3:{rouge:4,blanc:22,bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{rouge:-3,blanc:+6,bleu:-3},
            2:{rouge:+4,blanc:+1,bleu:-5},
            3:{rouge:+5,blanc:0,bleu:-5},
            4:{rouge:+2,blanc:+3,bleu:-5},
            5:{rouge:-4,blanc:+2,bleu:+2}
          };

          const today = new Date();
          today.setHours(0,0,0,0);
          const days = [];

          /* ======================
             J0 â€” EDF
          ====================== */
          days.push({
            date: fmt(today),
            couleur: edfToday,
            probabilites: {
              rouge: edfToday === "rouge" ? 100 : 0,
              blanc: edfToday === "blanc" ? 100 : 0,
              bleu:  edfToday === "bleu"  ? 100 : 0
            },
            fixed: true,
            sources: { reel: true }
          });

          /* ======================
             J1 â€” EDF (SEULEMENT SI PUBLIÃ‰)
          ====================== */
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);

          if (edfTomorrow) {
            days.push({
              date: fmt(tomorrow),
              couleur: edfTomorrow,
              probabilites: {
                rouge: edfTomorrow === "rouge" ? 100 : 0,
                blanc: edfTomorrow === "blanc" ? 100 : 0,
                bleu:  edfTomorrow === "bleu"  ? 100 : 0
              },
              fixed: true,
              sources: { reel: true }
            });
          }

          /* ======================
             J2 â†’ J9
          ====================== */
          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            const dow = d.getDay();
            const month = d.getMonth() + 1;
            const temp = temps[i] ?? 8;

            let base = HISTO_MONTH[month] || {rouge:10,blanc:25,bleu:65};
            let rouge = base.rouge;
            let blanc = base.blanc;
            let bleu  = base.bleu;

            if (HISTO_WEEKDAY[dow]) {
              rouge += HISTO_WEEKDAY[dow].rouge;
              blanc += HISTO_WEEKDAY[dow].blanc;
              bleu  += HISTO_WEEKDAY[dow].bleu;
            }

            /* ðŸŒ¦ï¸ MÃ‰TÃ‰O 40 % (J2 â†’ J6) */
            if (i <= 6) {
              if (temp < 0) { rouge += 12; bleu -= 6; }
              else if (temp < 3) { blanc += 12; bleu -= 6; }
            }

            /* âš¡ RTE 25 % DÃˆS J2 */
            if (consommation !== null) {
              if (tension < 55) { bleu += 6; blanc -= 3; rouge -= 3; }
              else if (tension <= 70) { blanc += 6; bleu -= 3; rouge -= 3; }
              else { rouge += 6; blanc += 3; bleu -= 9; }
            }

            /* RÃˆGLES TEMPO */
            if (dow === 0) { rouge = 0; blanc = 0; bleu = 100; }
            if (dow === 6) { blanc += rouge; rouge = 0; }

            const total = rouge + blanc + bleu;
            rouge = Math.round(rouge / total * 100);
            blanc = Math.round(blanc / total * 100);
            bleu  = 100 - rouge - blanc;

            let couleur = "bleu";
            if (rouge > blanc && rouge > bleu) couleur = "rouge";
            else if (blanc >= bleu) couleur = "blanc";

            days.push({
              date: fmt(d),
              couleur,
              probabilites: { rouge, blanc, bleu },
              fixed: false,
              temperature: temp,
              rteConsommation: consommation,
              rteTension: tension,
              sources: {
                meteo: true,
                historique: true,
                rte: consommation !== null
              }
            });
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          fs.writeFileSync("meta.json", JSON.stringify({
            updatedAt: new Date().toISOString(),
            rteConsommation: consommation,
            rteTension: tension
          }, null, 2));
          EOF

      # ======================
      # HISTORY (J0 / J1)
      # ======================
      - name: Update history
        run: |
          node <<'EOF'
          const fs = require("fs");
          const tempo = JSON.parse(fs.readFileSync("tempo.json","utf8"));
          let history = fs.existsSync("history.json")
            ? JSON.parse(fs.readFileSync("history.json","utf8"))
            : [];

          const upsert = e => {
            const i = history.findIndex(h => h.date === e.date);
            if (i >= 0) history[i] = e;
            else history.push(e);
          };

          tempo.forEach(d => {
            if (!d.fixed) return;
            upsert({
              date: d.date,
              predictedOn: d.date,
              horizon: 0,
              predictedColor: d.couleur,
              probabilites: d.probabilites,
              realColor: d.couleur,
              result: "correct"
            });
          });

          fs.writeFileSync("history.json", JSON.stringify(history, null, 2));
          EOF

      # ======================
      # ML
      # ======================
      - name: Train ML
        run: |
          python ML/train_ml.py || echo "ML skipped"

      - name: ML Predict
        run: |
          python ML/predict_ml.py || echo "ML skipped"

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json history.json edf_tempo.json ML/*.json ML/*.pkl || true
          git commit -m "Hourly Tempo update (EDF safe J1 + Weather + RTE + ML)" || echo "No changes"
          git push
