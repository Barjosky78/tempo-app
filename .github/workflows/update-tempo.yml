name: Update Tempo + History + Stats + ML (Hourly FINAL MULTI-SOURCE)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v3

      # ======================
      # PYTHON (ML)
      # ======================
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          pip install pandas scikit-learn joblib

      # ======================
      # NODE (SCRAPING)
      # ======================
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      # ======================
      # SCRAPE EDF SITE
      # ======================
      - name: Scrape EDF official site
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fetch = (...a)=>import("node-fetch").then(({default:f})=>f(...a));

          (async()=>{
            let today=null, tomorrow=null;
            try{
              const html = await (await fetch("https://particulier.edf.fr/fr/accueil/gestion-contrat/options/tempo.html")).text();
              const grab = label => {
                const m = html.match(new RegExp(label+"[\\s\\S]*?(Bleu|Blanc|Rouge)","i"));
                return m ? m[1].toLowerCase() : null;
              };
              today = grab("Aujourd’hui|Aujourd'hui");
              tomorrow = grab("Demain");
            }catch{}
            fs.writeFileSync("edf_site.json",JSON.stringify({today,tomorrow},null,2));
          })();
          EOF

      # ======================
      # SCRAPE HELLOWATT
      # ======================
      - name: Scrape HelloWatt
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fetch = (...a)=>import("node-fetch").then(({default:f})=>f(...a));

          (async()=>{
            let today=null, tomorrow=null;
            try{
              const html = await (await fetch("https://www.hellowatt.fr/edf/tempo")).text();
              const grab = label => {
                const m = html.match(new RegExp(label+"[\\s\\S]*?(Bleu|Blanc|Rouge)","i"));
                return m ? m[1].toLowerCase() : null;
              };
              today = grab("Aujourd’hui|Aujourd'hui");
              tomorrow = grab("Demain");
            }catch{}
            fs.writeFileSync("hellowatt.json",JSON.stringify({today,tomorrow},null,2));
          })();
          EOF

      # ======================
      # API TEMPO
      # ======================
      - name: Fetch API Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > api_tempo.json || echo '{}' > api_tempo.json

      # ======================
      # WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD tempo.json (MULTI-SOURCE FINAL)
      # ======================
      - name: Build tempo.json
        run: |
          node scripts/build_tempo_multisource.js

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_site.json hellowatt.json api_tempo.json
          git commit -m "Tempo update (EDF + HelloWatt + API + fallback)" || echo "No changes"
          git push
