name: Update Tempo + History + Stats + ML (EDF J0/J1 official)

on:
  schedule:
    - cron: '0 9 * * *'   # 10h France (hiver)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ======================
      # PYTHON (ML)
      # ======================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          pip install scikit-learn joblib pandas

      # ======================
      # EDF TEMPO OFFICIEL
      # ======================
      - name: Fetch official EDF Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > edf_tempo.json || echo '{}' > edf_tempo.json

      # ======================
      # MÉTÉO
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE consumption
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD TEMPO.JSON
      # ======================
      - name: Build tempo data
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          const edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8") || "{}");
          const edfToday = edf.today || "bleu";
          const edfTomorrow = edf.tomorrow || "bleu";

          const weather = JSON.parse(fs.readFileSync("weather.json","utf8") || "{}");
          const temps = weather.daily?.temperature_2m_mean || [];

          const rte = JSON.parse(fs.readFileSync("rte.json","utf8") || "{}");
          const consommation = rte.records?.[0]?.fields?.consommation ?? null;
          let tension = 60;
          if (consommation !== null) {
            if (consommation < 45000) tension = 50;
            else if (consommation < 55000) tension = 60;
            else if (consommation < 65000) tension = 70;
            else tension = 80;
          }

          const HISTO_MONTH = {
            11:{rouge:8,blanc:22,bleu:70},
            12:{rouge:14,blanc:30,bleu:56},
            1:{rouge:20,blanc:34,bleu:46},
            2:{rouge:17,blanc:33,bleu:50},
            3:{rouge:4,blanc:22,bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{rouge:-3,blanc:+6,bleu:-3},
            2:{rouge:+4,blanc:+1,bleu:-5},
            3:{rouge:+5,blanc:0,bleu:-5},
            4:{rouge:+2,blanc:+3,bleu:-5},
            5:{rouge:-4,blanc:+2,bleu:+2}
          };

          const today = new Date();
          today.setHours(0,0,0,0);
          const days = [];

          // J0
          days.push({
            date: fmt(today),
            couleur: edfToday,
            probabilites: { rouge:0, blanc:0, bleu:0, [edfToday]:100 },
            fixed:true,
            sources:{reel:true}
          });

          // J1
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate()+1);
          days.push({
            date: fmt(tomorrow),
            couleur: edfTomorrow,
            probabilites: { rouge:0, blanc:0, bleu:0, [edfTomorrow]:100 },
            fixed:true,
            sources:{reel:true}
          });

          for(let i=2;i<=9;i++){
            const d=new Date(today);
            d.setDate(today.getDate()+i);
            const dow=d.getDay(), month=d.getMonth()+1;
            const temp=temps[i]??8;

            let base=HISTO_MONTH[month]||{rouge:10,blanc:25,bleu:65};
            let {rouge,blanc,bleu}=base;

            if(HISTO_WEEKDAY[dow]){
              rouge+=HISTO_WEEKDAY[dow].rouge;
              blanc+=HISTO_WEEKDAY[dow].blanc;
              bleu+=HISTO_WEEKDAY[dow].bleu;
            }

            if(temp<0){rouge+=10;bleu-=5;}
            else if(temp<3){blanc+=10;bleu-=5;}

            if(i>=3 && consommation!==null){
              const boost=7;
              if(tension<55){bleu+=boost;blanc-=3;rouge-=3;}
              else if(tension<=70){blanc+=boost;bleu-=3;rouge-=3;}
              else{rouge+=boost;blanc+=3;bleu-=6;}
            }

            if(dow===0){rouge=0;blanc=0;bleu=100;}
            if(dow===6){blanc+=rouge;rouge=0;}

            const total=rouge+blanc+bleu;
            rouge=Math.round(rouge/total*100);
            blanc=Math.round(blanc/total*100);
            bleu=100-rouge-blanc;

            let couleur="bleu";
            if(rouge>blanc&&rouge>bleu)couleur="rouge";
            else if(blanc>=bleu)couleur="blanc";

            days.push({
              date:fmt(d),
              couleur,
              probabilites:{rouge,blanc,bleu},
              fixed:false,
              temperature:temp,
              rteConsommation:consommation,
              rteTension:tension,
              sources:{meteo:true,historique:true,rte:(i>=3&&consommation!==null)}
            });
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
          fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          EOF

      # ======================
      # UPDATE HISTORY (J0 / J1)
      # ======================
      - name: Update history with EDF validation
        run: |
          node <<'EOF'
          const fs = require("fs");

          const tempo = JSON.parse(fs.readFileSync("tempo.json","utf8"));
          let history = fs.existsSync("history.json")
            ? JSON.parse(fs.readFileSync("history.json","utf8"))
            : [];

          const upsert = entry => {
            const i = history.findIndex(h => h.date === entry.date);
            if (i >= 0) history[i] = entry;
            else history.push(entry);
          };

          tempo.forEach(day => {
            if (!day.fixed) return;
            upsert({
              date: day.date,
              predictedOn: day.date,
              horizon: 0,
              predictedColor: day.couleur,
              probabilites: day.probabilites,
              realColor: day.couleur,
              result: "correct"
            });
          });

          fs.writeFileSync("history.json", JSON.stringify(history, null, 2));
          EOF

      # ======================
      # ML
      # ======================
      - name: Train ML model
        run: |
          python ML/train_ml.py || echo "ML skipped"

      - name: ML prediction
        run: |
          python ML/predict_ml.py || echo "ML skipped"

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json history.json edf_tempo.json ML/*.json ML/*.pkl || true
          git commit -m "Tempo update: EDF J0/J1 validated + history + ML" || echo "No changes"
          git push
