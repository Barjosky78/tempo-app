name: Update Tempo + History + Stats + ML (Hourly FINAL)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 * * * *'   # Toutes les heures
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v3

      # ======================
      # PYTHON (ML)
      # ======================
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python deps
        run: pip install scikit-learn joblib pandas

      # ======================
      # EDF TEMPO (SOURCE DE VÉRITÉ)
      # ======================
      - name: Fetch EDF Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api \
          > edf_tempo.json || echo '{}' > edf_tempo.json

      # ======================
      # WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD tempo.json (LOGIQUE EDF STRICTE)
      # ======================
      - name: Build tempo.json
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          // ======================
          // LOAD EDF
          // ======================
          let edf = {};
          try { edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8")); } catch {}

          const today = new Date();
          today.setHours(0,0,0,0);

          const edfEntries = [];

          // Cas tableau
          if (Array.isArray(edf)) {
            edf.forEach(e => {
              if (e.date && e.couleur) {
                edfEntries.push({ date: e.date, couleur: e.couleur });
              }
            });
          }

          // Cas today / tomorrow
          if (edf.today) {
            edfEntries.push({ date: fmt(today), couleur: edf.today });
          }
          if (edf.tomorrow) {
            const d = new Date(today);
            d.setDate(today.getDate() + 1);
            edfEntries.push({ date: fmt(d), couleur: edf.tomorrow });
          }

          // ======================
          // LOAD WEATHER
          // ======================
          let temps = [];
          try {
            const w = JSON.parse(fs.readFileSync("weather.json","utf8"));
            temps = w.daily?.temperature_2m_mean || [];
          } catch {}

          // ======================
          // LOAD RTE
          // ======================
          let consommation = null;
          let tension = 60;
          try {
            const r = JSON.parse(fs.readFileSync("rte.json","utf8"));
            consommation = r.records?.[0]?.fields?.consommation ?? null;
            if (consommation !== null) {
              if (consommation < 45000) tension = 50;
              else if (consommation < 55000) tension = 60;
              else if (consommation < 65000) tension = 70;
              else tension = 80;
            }
          } catch {}

          // ======================
          // HISTORIQUE
          // ======================
          const HISTO_MONTH = {
            11:{rouge:8,blanc:22,bleu:70},
            12:{rouge:14,blanc:30,bleu:56},
            1:{rouge:20,blanc:34,bleu:46},
            2:{rouge:17,blanc:33,bleu:50},
            3:{rouge:4,blanc:22,bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{rouge:-3,blanc:+6,bleu:-3},
            2:{rouge:+4,blanc:+1,bleu:-5},
            3:{rouge:+5,blanc:0,bleu:-5},
            4:{rouge:+2,blanc:+3,bleu:-5},
            5:{rouge:-4,blanc:+2,bleu:+2}
          };

          const days = [];

          // ======================
          // J0 + J1 EDF (LOCKÉS)
          // ======================
          for (let i=0;i<=1;i++) {
            const d = new Date(today);
            d.setDate(today.getDate()+i);
            const edfDay = edfEntries.find(e => e.date === fmt(d));
            if (edfDay) {
              days.push({
                date: edfDay.date,
                couleur: edfDay.couleur,
                probabilites:{ rouge:0, blanc:0, bleu:0, [edfDay.couleur]:100 },
                fixed:true,
                sources:{reel:true}
              });
            }
          }

          // ======================
          // J+2 → J+9 (CALCULÉS)
          // ======================
          for (let i=2;i<=9;i++) {
            const d = new Date(today);
            d.setDate(today.getDate()+i);
            const dow = d.getDay();

            let base = HISTO_MONTH[d.getMonth()+1] || {rouge:10,blanc:25,bleu:65};
            let rouge=base.rouge, blanc=base.blanc, bleu=base.bleu;

            if (HISTO_WEEKDAY[dow]) {
              rouge+=HISTO_WEEKDAY[dow].rouge;
              blanc+=HISTO_WEEKDAY[dow].blanc;
              bleu+=HISTO_WEEKDAY[dow].bleu;
            }

            const temp = temps[i] ?? 8;
            if (i<=6 && temp<3){blanc+=10;bleu-=5;}
            if (i<=6 && temp<0){rouge+=8;bleu-=5;}

            if (consommation!==null){
              if (tension < 55)      { bleu+=5; blanc-=3; rouge-=2; }
              else if (tension<=70) { blanc+=10; bleu-=5; rouge-=5; }
              else                  { rouge+=7; blanc+=3; bleu-=10; }
            }

            if (dow===6) rouge=0;
            if (dow===0) { rouge=0; blanc=0; bleu=100; }

            const total=rouge+blanc+bleu;
            rouge=Math.round(rouge/total*100);
            blanc=Math.round(blanc/total*100);
            bleu=100-rouge-blanc;

            let couleur="bleu";
            if (rouge>blanc&&rouge>bleu) couleur="rouge";
            else if (blanc>=bleu) couleur="blanc";

            days.push({
              date:fmt(d),
              couleur,
              probabilites:{rouge,blanc,bleu},
              fixed:false,
              temperature:temp,
              rteConsommation:consommation,
              rteTension:tension,
              sources:{historique:true,meteo:true,rte:consommation!==null}
            });
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
          fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          EOF

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_tempo.json
          git commit -m "Final EDF-correct Tempo update (J0/J1 locked)" || echo "No changes"
          git push
