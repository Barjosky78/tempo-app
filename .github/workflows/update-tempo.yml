name: Update Tempo + History + Stats (J1 weather estimation)

on:
  schedule:
    # 9h UTC = 10h heure française (hiver)
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ======================
      # MÉTÉO (Open-Meteo)
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" > weather.json

      # ======================
      # BUILD TEMPO.JSON
      # ======================
      - name: Build tempo data
        run: |
          node <<'EOF'
          const fs = require("fs");

          function fmt(d){ return d.toISOString().split("T")[0]; }

          /* ======================
             CHARGEMENT MÉTÉO
          ====================== */
          const weather = JSON.parse(fs.readFileSync("weather.json","utf8"));
          const temps = weather.daily.temperature_2m_mean || [];

          /* ======================
             DATES
          ====================== */
          const today = new Date();
          today.setHours(0,0,0,0);

          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);

          /* ======================
             AUJOURD’HUI (RÉEL)
             ⚠️ volontairement fixé
          ====================== */
          const todayColor = "bleu";

          function fixed(color){
            return {
              rouge: color === "rouge" ? 100 : 0,
              blanc: color === "blanc" ? 100 : 0,
              bleu:  color === "bleu"  ? 100 : 0
            };
          }

          /* ======================
             CONSTANTES HISTORIQUES
          ====================== */
          const HISTO_MONTH = {
            11:{rouge:8,  blanc:22, bleu:70},
            12:{rouge:14, blanc:30, bleu:56},
            1:{rouge:20, blanc:34, bleu:46},
            2:{rouge:17, blanc:33, bleu:50},
            3:{rouge:4,  blanc:22, bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{ rouge:-3, blanc:+6, bleu:-3 },
            2:{ rouge:+4, blanc:+1, bleu:-5 },
            3:{ rouge:+5, blanc: 0, bleu:-5 },
            4:{ rouge:+2, blanc:+3, bleu:-5 },
            5:{ rouge:-4, blanc:+2, bleu:+2 }
          };

          /* ======================
             FROID ÉTENDU
          ====================== */
          const coldSpans = [];
          let span = 0;
          for(let i=0;i<temps.length;i++){
            if(temps[i] < 3) span++;
            else span = 0;
            coldSpans[i] = span;
          }

          /* ======================
             BUILD TEMPO
          ====================== */
          const days = [];

          // ---------- AUJOURD’HUI ----------
          days.push({
            date: fmt(today),
            couleur: todayColor,
            probabilites: fixed(todayColor),
            fixed: true
          });

          // ---------- DEMAIN (J+1 ESTIMATION MÉTÉO) ----------
          const tempJ1 = temps[1] ?? 5;
          const dowJ1 = tomorrow.getDay();

          let rouge = 20;
          let blanc = 40;
          let bleu  = 40;

          // Effet température
          if (tempJ1 < 0) {
            rouge += 15; bleu -= 10;
          } else if (tempJ1 < 3) {
            blanc += 15; bleu -= 10;
          } else if (tempJ1 > 6) {
            bleu += 10; blanc -= 5;
          }

          // Règles EDF connues
          if (dowJ1 === 0) {
            rouge = 0; blanc = 0; bleu = 100;
          } else if (dowJ1 === 6) {
            blanc += Math.round(rouge / 2);
            bleu  += Math.round(rouge / 2);
            rouge = 0;
          }

          // Normalisation
          const totJ1 = rouge + blanc + bleu;
          rouge = Math.round(rouge / totJ1 * 100);
          blanc = Math.round(blanc / totJ1 * 100);
          bleu  = 100 - rouge - blanc;

          let couleurJ1 = "bleu";
          if (rouge > blanc && rouge > bleu) couleurJ1 = "rouge";
          else if (blanc > bleu) couleurJ1 = "blanc";

          days.push({
            date: fmt(tomorrow),
            couleur: couleurJ1,
            probabilites: { rouge, blanc, bleu },
            fixed: false,
            estimated: true
          });

          let lastColors = days.map(d => d.couleur);

          // ---------- J+2 → J+9 (MODÈLE COMPLET) ----------
          for(let i=2;i<=9;i++){
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            const dow = d.getDay();
            const month = d.getMonth() + 1;
            const temp = temps[i] ?? 8;
            const spanDays = coldSpans[i] || 0;

            if(dow === 0){
              days.push({
                date: fmt(d),
                couleur: "bleu",
                probabilites:{rouge:0,blanc:0,bleu:100},
                fixed:true
              });
              lastColors.push("bleu");
              continue;
            }

            let base = HISTO_MONTH[month] || {rouge:10, blanc:25, bleu:65};
            let r = base.rouge;
            let b = base.blanc;
            let bl = base.bleu;

            if(HISTO_WEEKDAY[dow]){
              r += HISTO_WEEKDAY[dow].rouge;
              b += HISTO_WEEKDAY[dow].blanc;
              bl+= HISTO_WEEKDAY[dow].bleu;
            }

            if(month >= 11 || month <= 3){
              bl -= 5; b += 3; r += 2;
            }

            const factor = (10 - i) / 10;
            r = Math.max(2, Math.round(r * factor));
            b = Math.round(b * factor);
            bl = 100 - r - b;

            if(temp < 0 && spanDays >= 3){
              r += 8; b += 12; bl -= 20;
            } else if(temp < 3 && spanDays >= 3){
              b += 15; bl -= 15;
            }

            const total = r + b + bl;
            r = Math.round(r / total * 100);
            b = Math.round(b / total * 100);
            bl = 100 - r - b;

            let c = "bleu";
            if(r > b && r > bl) c = "rouge";
            else if(b > bl) c = "blanc";

            days.push({
              date: fmt(d),
              couleur: c,
              probabilites:{rouge:r, blanc:b, bleu:bl},
              fixed:false
            });

            lastColors.push(c);
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days,null,2));
          fs.writeFileSync(
            "meta.json",
            JSON.stringify({ updatedAt: new Date().toISOString() }, null, 2)
          );
          EOF

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json
          git commit -m "Update tempo (J1 weather estimation)" || echo "No changes"
          git push
