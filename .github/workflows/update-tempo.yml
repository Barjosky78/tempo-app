name: Update Tempo + History + Stats + ML (Hourly FINAL SAFE)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v3

      # ======================
      # PYTHON (ML)
      # ======================
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          pip install pandas scikit-learn joblib

      # ======================
      # EDF TEMPO (API)
      # ======================
      - name: Fetch EDF Tempo API
        run: |
          curl -s https://www.api-couleur-tempo.fr/api \
          > edf_tempo.json || echo '{}' > edf_tempo.json

      # ======================
      # HELLOWATT (HTML)
      # ======================
      - name: Fetch HelloWatt
        run: |
          curl -s https://www.hellowatt.fr/tempo > hellowatt.html || echo "" > hellowatt.html

      # ======================
      # WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD tempo.json
      # ======================
      - name: Build tempo.json (SAFE J0/J1)
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          /* ========= LOAD EDF API ========= */
          let edf = {};
          try { edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8")); } catch {}

          const norm = v => typeof v === "string" ? v.toLowerCase() : null;

          const edfToday =
            norm(edf.today) ||
            norm(edf.aujourd_hui) ||
            norm(edf.jourJ) ||
            norm(edf.couleurJourJ) ||
            null;

          const edfTomorrow =
            norm(edf.tomorrow) ||
            norm(edf.demain) ||
            norm(edf.couleurJourJ1) ||
            null;

          /* ========= HELLOWATT ========= */
          let hwTomorrow = null;
          try {
            const html = fs.readFileSync("hellowatt.html","utf8").toLowerCase();
            if (html.includes("demain") && html.includes("bleu")) hwTomorrow = "bleu";
            if (html.includes("demain") && html.includes("blanc")) hwTomorrow = "blanc";
            if (html.includes("demain") && html.includes("rouge")) hwTomorrow = "rouge";
          } catch {}

          /* ========= WEATHER ========= */
          let temps = [];
          try {
            const w = JSON.parse(fs.readFileSync("weather.json","utf8"));
            temps = w.daily?.temperature_2m_mean || [];
          } catch {}

          /* ========= RTE ========= */
          let consommation = null;
          let tension = 60;
          try {
            const r = JSON.parse(fs.readFileSync("rte.json","utf8"));
            consommation = r.records?.[0]?.fields?.consommation ?? null;
            if (consommation !== null) {
              if (consommation < 45000) tension = 50;
              else if (consommation < 55000) tension = 60;
              else if (consommation < 65000) tension = 70;
              else tension = 80;
            }
          } catch {}

          /* ========= HISTO ========= */
          const HISTO_MONTH = {
            11:{rouge:8,blanc:22,bleu:70},
            12:{rouge:14,blanc:30,bleu:56},
            1:{rouge:20,blanc:34,bleu:46},
            2:{rouge:17,blanc:33,bleu:50},
            3:{rouge:4,blanc:22,bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{rouge:-3,blanc:+6,bleu:-3},
            2:{rouge:+4,blanc:+1,bleu:-5},
            3:{rouge:+5,blanc:0,bleu:-5},
            4:{rouge:+2,blanc:+3,bleu:-5},
            5:{rouge:-4,blanc:+2,bleu:+2}
          };

          const today = new Date();
          today.setHours(0,0,0,0);
          const days = [];

          /* ========= J0 ========= */
          const j0 = edfToday || "bleu";
          days.push({
            date: fmt(today),
            couleur: j0,
            probabilites:{rouge:0,blanc:0,bleu:0,[j0]:100},
            fixed:true,
            sources:{edf:true}
          });

          /* ========= J1 ========= */
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate()+1);
          const dow1 = tomorrow.getDay();

          let j1Color = edfTomorrow || hwTomorrow || null;
          let j1Fixed = false;
          let j1Sources = {};

          if (edfTomorrow) {
            j1Fixed = true;
            j1Sources.edf = true;
          } else if (hwTomorrow) {
            j1Fixed = true;
            j1Sources.hellowatt = true;
          }

          let rouge=0, blanc=0, bleu=0;

          if (!j1Color) {
            let base = HISTO_MONTH[tomorrow.getMonth()+1] || {rouge:10,blanc:25,bleu:65};
            rouge=base.rouge; blanc=base.blanc; bleu=base.bleu;

            if (HISTO_WEEKDAY[dow1]) {
              rouge+=HISTO_WEEKDAY[dow1].rouge;
              blanc+=HISTO_WEEKDAY[dow1].blanc;
              bleu+=HISTO_WEEKDAY[dow1].bleu;
            }

            const temp = temps[1] ?? 8;
            if (temp < 3) { blanc+=8; bleu-=4; }
            if (temp < 0) { rouge+=6; bleu-=4; }

            if (consommation!==null) {
              if (tension<55){bleu+=5;blanc-=3;rouge-=2;}
              else if (tension<=70){blanc+=10;bleu-=5;rouge-=5;}
              else{rouge+=7;blanc+=3;bleu-=10;}
            }

            if (dow1===6) rouge=0;
            if (dow1===0){rouge=0;blanc=0;bleu=100;}

            const total=rouge+blanc+bleu;
            rouge=Math.round(rouge/total*100);
            blanc=Math.round(blanc/total*100);
            bleu=100-rouge-blanc;

            j1Color = rouge>blanc&&rouge>bleu?"rouge":(blanc>=bleu?"blanc":"bleu");
            j1Sources={historique:true,meteo:true,rte:consommation!==null};
          }

          days.push({
            date:fmt(tomorrow),
            couleur:j1Color,
            probabilites:j1Fixed?{rouge:0,blanc:0,bleu:0,[j1Color]:100}:{rouge,blanc,bleu},
            fixed:j1Fixed,
            sources:j1Sources
          });

          /* ========= J2 â†’ J9 ========= */
          for(let i=2;i<=9;i++){
            const d=new Date(today); d.setDate(today.getDate()+i);
            const dow=d.getDay();

            let base=HISTO_MONTH[d.getMonth()+1]||{rouge:10,blanc:25,bleu:65};
            let r=base.rouge,b=base.blanc,bl=base.bleu;

            if(HISTO_WEEKDAY[dow]){
              r+=HISTO_WEEKDAY[dow].rouge;
              b+=HISTO_WEEKDAY[dow].blanc;
              bl+=HISTO_WEEKDAY[dow].bleu;
            }

            const temp=temps[i]??8;
            if(temp<3){b+=8;bl-=4;}
            if(temp<0){r+=6;bl-=4;}

            const total=r+b+bl;
            r=Math.round(r/total*100);
            b=Math.round(b/total*100);
            bl=100-r-b;

            const c=r>b&&r>bl?"rouge":(b>=bl?"blanc":"bleu");

            days.push({
              date:fmt(d),
              couleur:c,
              probabilites:{rouge:r,blanc:b,bleu:bl},
              fixed:false,
              sources:{historique:true,meteo:true}
            });
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
          fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          EOF

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_tempo.json hellowatt.html
          git commit -m "Tempo update FINAL SAFE (EDF + HelloWatt + fallback)" || echo "No changes"
          git push
