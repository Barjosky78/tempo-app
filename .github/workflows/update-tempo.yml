name: Update Tempo + History + Stats (EDF White Bias)

on:
  schedule:
    # 9h UTC = 10h heure française (hiver)
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch Hello Watt
        run: |
          curl -s "https://www.hellowatt.fr/calendrier-tempo-edf-couleur-jour/" > page.html

      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" > weather.json

      - name: Build data
        run: |
          node <<'EOF'
          const fs = require("fs");

          function fmt(d){ return d.toISOString().split("T")[0]; }

          const html = fs.readFileSync("page.html","utf8");
          const weather = JSON.parse(fs.readFileSync("weather.json","utf8"));
          const temps = weather.daily.temperature_2m_mean || [];

          let history = fs.existsSync("history.json")
            ? JSON.parse(fs.readFileSync("history.json","utf8"))
            : [];

          /* ======================
             OFFICIAL COLORS (ROBUST)
          ====================== */

          function extractColor(label) {
            const regex = new RegExp(label + "[^A-Za-z]*(Bleu|Blanc|Rouge)", "i");
            const match = html.match(regex);
            return match ? match[1].toLowerCase() : null;
          }

          const today = new Date(); today.setHours(0,0,0,0);
          const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);

          const todayStr = fmt(today);

          const todayColor = extractColor("Aujourd.?hui") || "bleu";
          const tomorrowColor = extractColor("Demain") || todayColor;

          function fixed(color){
            return {
              rouge: color==="rouge"?100:0,
              blanc: color==="blanc"?100:0,
              bleu:  color==="bleu"?100:0
            };
          }

          /* ======================
             CONSTANTES MODELE
          ====================== */
          const HISTO_MONTH = {
            11:{rouge:8,  blanc:22, bleu:70},
            12:{rouge:14, blanc:30, bleu:56},
            1:{rouge:20, blanc:34, bleu:46},
            2:{rouge:17, blanc:33, bleu:50},
            3:{rouge:4,  blanc:22, bleu:74}
          };

          const HISTO_WEEKDAY = {
            1:{ rouge:-3, blanc:+6, bleu:-3 },
            2:{ rouge:+4, blanc:+1, bleu:-5 },
            3:{ rouge:+5, blanc: 0, bleu:-5 },
            4:{ rouge:+2, blanc:+3, bleu:-5 },
            5:{ rouge:-4, blanc:+2, bleu:+2 }
          };

          /* ======================
             FROID ETENDU
          ====================== */
          const coldSpans=[];
          let span=0;
          for(let i=0;i<temps.length;i++){
            if(temps[i]<3) span++; else span=0;
            coldSpans[i]=span;
          }

          /* ======================
             BUILD TEMPO
          ====================== */
          const days=[];
          days.push({
            date: todayStr,
            couleur: todayColor,
            probabilites: fixed(todayColor),
            fixed: true
          });

          days.push({
            date: fmt(tomorrow),
            couleur: tomorrowColor,
            probabilites: fixed(tomorrowColor),
            fixed: true
          });

          let lastColors = days.map(d=>d.couleur);

          for(let i=2;i<=9;i++){
            const d = new Date(today);
            d.setDate(today.getDate()+i);
            const dow = d.getDay();
            const month = d.getMonth()+1;
            const temp = temps[i] ?? 10;
            const spanDays = coldSpans[i] || 0;

            if(dow===0){
              days.push({
                date: fmt(d),
                couleur: "bleu",
                probabilites:{rouge:0,blanc:0,bleu:100},
                fixed:true
              });
              lastColors.push("bleu");
              continue;
            }

            let base = HISTO_MONTH[month] || {rouge:10,blanc:25,bleu:65};
            let rouge = base.rouge;
            let blanc = base.blanc;
            let bleu  = base.bleu;

            if(HISTO_WEEKDAY[dow]){
              rouge += HISTO_WEEKDAY[dow].rouge;
              blanc += HISTO_WEEKDAY[dow].blanc;
              bleu  += HISTO_WEEKDAY[dow].bleu;
            }

            const recent = lastColors.slice(-2);
            if(recent.includes("rouge")){
              rouge -= 10;
              blanc += 5;
              bleu  += 5;
            }
            if(recent.every(c=>c==="bleu")){
              blanc += 5;
              bleu  -= 5;
            }

            if(month>=11 || month<=3){
              bleu  -= 5;
              blanc += 3;
              rouge += 2;
            }

            const factor=(10-i)/10;
            rouge=Math.max(2,Math.round(rouge*factor));
            blanc=Math.round(blanc*factor);
            bleu=100-rouge-blanc;

            if(temp<0 && spanDays>=3){
              rouge+=8; blanc+=12; bleu-=20;
            }else if(temp<3 && spanDays>=3){
              blanc+=15; bleu-=15;
            }else if(temp<3){
              blanc+=8; bleu-=8;
            }

            if(dow===1 && spanDays>=3 && temp<=0){
              rouge+=5; bleu-=5;
            }

            if(dow===6){
              blanc+=Math.round(rouge/2);
              bleu +=Math.round(rouge/2);
              rouge=0;
            }

            const total = rouge+blanc+bleu;
            rouge=Math.round(rouge/total*100);
            blanc=Math.round(blanc/total*100);
            bleu=100-rouge-blanc;

            let couleur="bleu";
            if(rouge>blanc && rouge>bleu) couleur="rouge";
            else if(blanc>bleu) couleur="blanc";

            // ⭐ BLANC TAMPON EDF
            if (Math.abs(blanc - bleu) <= 5 && blanc > rouge) {
              couleur = "blanc";
            }

            days.push({
              date: fmt(d),
              couleur,
              probabilites:{rouge,blanc,bleu},
              fixed:false
            });

            lastColors.push(couleur);
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));

          // ⏱️ META
          const meta = {
            updatedAt: new Date().toISOString()
          };
          fs.writeFileSync("meta.json", JSON.stringify(meta,null,2));
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json
          git commit -m "Fix parsing today/tomorrow + timestamp" || echo "No changes"
          git push
