name: Update Tempo JSON (Option 1)

on:
  schedule:
    - cron: '0 6 * * *'   # Tous les jours √† 06h UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tempo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # 1Ô∏è‚É£ R√©cup√©ration Aujourd'hui / Demain depuis Hello Watt
      - name: Fetch Hello Watt page
        run: |
          curl -s "https://www.hellowatt.fr/calendrier-tempo-edf-couleur-jour/" > page.html

      # 2Ô∏è‚É£ G√©n√©ration tempo.json avec OPTION 1
      - name: Build tempo.json (Option 1)
        run: |
          node <<'EOF'
          const fs = require("fs");

          const html = fs.readFileSync("page.html", "utf8");

          // üîé Extraction simple des couleurs officielles
          const matches = [...html.matchAll(/Jour (Bleu|Blanc|Rouge)/gi)]
            .map(m => m[1].toLowerCase());

          const todayColor = matches[0] || "bleu";
          const tomorrowColor = matches[1] || todayColor;

          function proba(color) {
            return {
              rouge: color === "rouge" ? 100 : 0,
              blanc: color === "blanc" ? 100 : 0,
              bleu:  color === "bleu"  ? 100 : 0
            };
          }

          function fmt(d) {
            return d.toISOString().split("T")[0];
          }

          const days = [];
          const today = new Date();
          today.setHours(0,0,0,0);

          // üîí AUJOURD'HUI (officiel)
          days.push({
            date: fmt(today),
            couleur: todayColor,
            probabilites: proba(todayColor)
          });

          // üîí DEMAIN (officiel)
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          days.push({
            date: fmt(tomorrow),
            couleur: tomorrowColor,
            probabilites: proba(tomorrowColor)
          });

          // ===============================
          // üîÆ J+2 ‚Üí J+9 ‚Äî OPTION 1 ACTIVE
          // ===============================

          let lastColors = days.map(d => d.couleur);

          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            const month = d.getMonth() + 1; // 1 = janvier
            const dayOfWeek = d.getDay();   // 0 = dimanche

            // üìä Base saisonni√®re
            let rouge = 10;
            let blanc = 25;
            let bleu  = 65;

            // ‚ùÑÔ∏è C≈ìur de l‚Äôhiver (janvier / f√©vrier)
            if (month === 1 || month === 2) {
              rouge = 20;
              blanc = 35;
              bleu  = 45;
            }

            // üå± Fin d‚Äôhiver (mars)
            if (month === 3) {
              rouge = 5;
              blanc = 20;
              bleu  = 75;
            }

            // üìÜ Ajustement jour de semaine
            if (dayOfWeek === 1 || dayOfWeek === 2) { // lundi / mardi
              rouge += 5;
              bleu  -= 5;
            }

            if (dayOfWeek === 5) { // vendredi
              rouge -= 5;
              bleu  += 5;
            }

            // üîÅ S√©quences pr√©c√©dentes
            const recent = lastColors.slice(-2);

            // ‚ùå Pas de rouge cons√©cutif
            if (recent.includes("rouge")) {
              rouge -= 10;
              bleu  += 10;
            }

            // üîµ Apr√®s plusieurs bleus ‚Üí blanc favoris√©
            if (recent.every(c => c === "bleu")) {
              blanc += 5;
              bleu  -= 5;
            }

            // üìâ Lissage avec la distance
            const factor = (10 - i) / 10;
            rouge = Math.max(3, Math.round(rouge * factor));
            blanc = Math.round(blanc * factor);
            bleu  = 100 - rouge - blanc;

            // üéØ Couleur dominante
            let couleur = "bleu";
            if (rouge > blanc && rouge > bleu) couleur = "rouge";
            else if (blanc > bleu) couleur = "blanc";

            days.push({
              date: fmt(d),
              couleur,
              probabilites: { rouge, blanc, bleu }
            });

            lastColors.push(couleur);
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          EOF

      # 3Ô∏è‚É£ Commit & push
      - name: Commit and push tempo.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json
          git commit -m "Update tempo.json (Option 1 statistical forecast)" || echo "No changes"
          git push
