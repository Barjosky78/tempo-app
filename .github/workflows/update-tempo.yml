name: Update Tempo (EDF Official + Forecast)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch EDF Tempo (OFFICIAL API)
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > edf_tempo.json

      - name: Build tempo.json (J0/J1 FIXED)
        run: |
          node <<'EOF'
          const fs = require("fs");

          const edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8"));

          const today = new Date();
          today.setHours(0,0,0,0);

          const fmt = d => d.toISOString().split("T")[0];

          const days = [];

          /* ===== J0 ===== */
          if (!edf.today) {
            console.error("EDF TODAY MISSING");
            process.exit(1);
          }

          days.push({
            date: fmt(today),
            couleur: edf.today,
            probabilites: {
              rouge: 0,
              blanc: 0,
              bleu: 0,
              [edf.today]: 100
            },
            fixed: true,
            sources: { edf: true }
          });

          /* ===== J1 ===== */
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);

          if (edf.tomorrow) {
            days.push({
              date: fmt(tomorrow),
              couleur: edf.tomorrow,
              probabilites: {
                rouge: 0,
                blanc: 0,
                bleu: 0,
                [edf.tomorrow]: 100
              },
              fixed: true,
              sources: { edf: true }
            });
          }

          /* ===== J2 â†’ J9 (PLACEHOLDER) ===== */
          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            days.push({
              date: fmt(d),
              couleur: "bleu",
              probabilites: { rouge: 10, blanc: 25, bleu: 65 },
              fixed: false,
              sources: { historique: true }
            });
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          fs.writeFileSync("meta.json", JSON.stringify({
            updatedAt: new Date().toISOString()
          }, null, 2));
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_tempo.json
          git commit -m "Fix J0/J1 using official EDF API" || echo "No changes"
          git push
