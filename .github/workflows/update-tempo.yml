name: Update Tempo JSON (History + Weather + Weekend Fix)

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tempo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # 1Ô∏è‚É£ Officiel aujourd‚Äôhui / demain
      - name: Fetch Hello Watt
        run: |
          curl -s "https://www.hellowatt.fr/calendrier-tempo-edf-couleur-jour/" > page.html

      # 2Ô∏è‚É£ M√©t√©o (proxy France)
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" > weather.json

      # 3Ô∏è‚É£ G√©n√©ration tempo.json
      - name: Build tempo.json
        run: |
          node <<'EOF'
          const fs = require("fs");

          const html = fs.readFileSync("page.html", "utf8");
          const weather = JSON.parse(fs.readFileSync("weather.json", "utf8"));

          const matches = [...html.matchAll(/Jour (Bleu|Blanc|Rouge)/gi)]
            .map(m => m[1].toLowerCase());

          const todayColor = matches[0] || "bleu";
          const tomorrowColor = matches[1] || todayColor;

          function fmt(d) {
            return d.toISOString().split("T")[0];
          }

          function proba(color) {
            return {
              rouge: color === "rouge" ? 100 : 0,
              blanc: color === "blanc" ? 100 : 0,
              bleu:  color === "bleu"  ? 100 : 0
            };
          }

          const HISTO_MONTH = {
            11: { rouge: 8,  blanc: 22, bleu: 70 },
            12: { rouge: 14, blanc: 30, bleu: 56 },
            1:  { rouge: 20, blanc: 34, bleu: 46 },
            2:  { rouge: 17, blanc: 33, bleu: 50 },
            3:  { rouge: 4,  blanc: 22, bleu: 74 }
          };

          const HISTO_WEEKDAY = {
            1: { rouge: +4 },
            2: { rouge: +3 },
            3: { rouge: +1 },
            4: { rouge:  0 },
            5: { rouge: -3 }
          };

          const temps = weather.daily.temperature_2m_mean;

          const days = [];
          const today = new Date();
          today.setHours(0,0,0,0);

          // Aujourd‚Äôhui
          days.push({
            date: fmt(today),
            couleur: todayColor,
            probabilites: proba(todayColor),
            coldRisk: 0,
            fixed: true
          });

          // Demain
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          days.push({
            date: fmt(tomorrow),
            couleur: tomorrowColor,
            probabilites: proba(tomorrowColor),
            coldRisk: 0,
            fixed: true
          });

          let lastColors = days.map(d => d.couleur);

          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            const dayOfWeek = d.getDay(); // 0 = dimanche
            const month = d.getMonth() + 1;
            const temp = temps[i] ?? 10;

            // üîµ DIMANCHE = BLEU FIXE
            if (dayOfWeek === 0) {
              days.push({
                date: fmt(d),
                couleur: "bleu",
                probabilites: { rouge: 0, blanc: 0, bleu: 100 },
                coldRisk: 0,
                fixed: true
              });
              lastColors.push("bleu");
              continue;
            }

            let base = HISTO_MONTH[month] || { rouge: 10, blanc: 25, bleu: 65 };
            let rouge = base.rouge;
            let blanc = base.blanc;
            let bleu  = base.bleu;

            // Jour semaine
            if (HISTO_WEEKDAY[dayOfWeek]) {
              rouge += HISTO_WEEKDAY[dayOfWeek].rouge;
              bleu  -= HISTO_WEEKDAY[dayOfWeek].rouge;
            }

            // S√©quences
            const recent = lastColors.slice(-2);
            if (recent.includes("rouge")) {
              rouge -= 10;
              bleu  += 10;
            }
            if (recent.every(c => c === "bleu")) {
              blanc += 5;
              bleu  -= 5;
            }

            // Lissage
            const factor = (10 - i) / 10;
            rouge = Math.max(2, Math.round(rouge * factor));
            blanc = Math.round(blanc * factor);
            bleu  = 100 - rouge - blanc;

            // üå¶Ô∏è m√©t√©o (bleu ‚Üî blanc)
            let coldRisk = 0;
            if (temp < 0) {
              blanc += 15;
              bleu  -= 15;
              coldRisk = 2;
            } else if (temp < 3) {
              blanc += 10;
              bleu  -= 10;
              coldRisk = 1;
            }

            // üü° SAMEDI = PAS DE ROUGE
            if (dayOfWeek === 6) {
              blanc += Math.round(rouge / 2);
              bleu  += Math.round(rouge / 2);
              rouge = 0;
            }

            // S√©curit√© finale
            const total = blanc + bleu;
            blanc = Math.round((blanc / total) * 100);
            bleu  = 100 - blanc;

            let couleur = blanc > bleu ? "blanc" : "bleu";

            days.push({
              date: fmt(d),
              couleur,
              probabilites: { rouge: 0, blanc, bleu },
              coldRisk,
              fixed: false
            });

            lastColors.push(couleur);
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json
          git commit -m "Fix weekend rules (Sunday fixed, Saturday no red)" || echo "No changes"
          git push
