name: Update Tempo JSON

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tempo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch and build Tempo JSON safely
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > api.json || echo "{}" > api.json

          node <<'EOF'
          const fs = require("fs");

          let api = {};
          try {
            api = JSON.parse(fs.readFileSync("api.json","utf8"));
          } catch {
            api = {};
          }

          function safeColor(obj, fallback="bleu") {
            if (!obj) return fallback;
            if (typeof obj === "string") return obj;
            if (obj.couleur) return obj.couleur;
            if (obj.color) return obj.color;
            return fallback;
          }

          function probaFromColor(c) {
            return {
              rouge: c === "rouge" ? 100 : 0,
              blanc: c === "blanc" ? 100 : 0,
              bleu:  c === "bleu"  ? 100 : 0
            };
          }

          const today = new Date();
          const days = [];

          function fmt(d) {
            return d.toISOString().split("T")[0];
          }

          // ðŸ”’ AUJOURD'HUI (officiel si possible)
          const todayColor = safeColor(api.today, "bleu");
          days.push({
            date: fmt(today),
            couleur: todayColor,
            probabilites: probaFromColor(todayColor)
          });

          // ðŸ”’ DEMAIN (officiel si possible)
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          const tomorrowColor = safeColor(api.tomorrow, "bleu");
          days.push({
            date: fmt(tomorrow),
            couleur: tomorrowColor,
            probabilites: probaFromColor(tomorrowColor)
          });

          // ðŸ”® J+2 â†’ J+9 (prÃ©visions simples)
          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            const r = Math.floor(Math.random() * 50);
            const b = Math.floor(Math.random() * (100 - r));
            const bl = 100 - r - b;

            let couleur = "bleu";
            if (r > b && r > bl) couleur = "rouge";
            else if (b > bl) couleur = "blanc";

            days.push({
              date: fmt(d),
              couleur,
              probabilites: { rouge: r, blanc: b, bleu: bl }
            });
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json
          git commit -m "Auto update tempo.json (safe official today/tomorrow)" || echo "No change"
          git push
