name: Update Tempo OFFICIAL EDF (Hourly Stable)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v4

      # ======================
      # NODE (SCRAPE EDF)
      # ======================
      - name: Scrape EDF official Tempo
        run: |
          node scripts/scrape_edf_tempo.js > edf_scraped.json

      # ======================
      # WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json

      # ======================
      # RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json

      # ======================
      # BUILD TEMPO.JSON (PROPRE)
      # ======================
      - name: Build tempo.json
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          // ðŸ”‘ Fuseau EDF
          const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Paris" }));
          now.setHours(0,0,0,0);

          const edf = JSON.parse(fs.readFileSync("edf_scraped.json","utf8"));
          const weather = JSON.parse(fs.readFileSync("weather.json","utf8"));
          const rte = JSON.parse(fs.readFileSync("rte.json","utf8"));

          const temps = weather.daily?.temperature_2m_mean || [];

          let tension = 60;
          const conso = rte.records?.[0]?.fields?.consommation ?? null;
          if (conso !== null) {
            if (conso < 45000) tension = 50;
            else if (conso < 55000) tension = 60;
            else if (conso < 65000) tension = 70;
            else tension = 80;
          }

          const days = [];

          // ======================
          // J0 â€” EDF OFFICIEL
          // ======================
          if (edf.today) {
            days.push({
              date: fmt(now),
              couleur: edf.today,
              probabilites: { rouge:0, blanc:0, bleu:0, [edf.today]:100 },
              fixed: true,
              sources: { edf:true }
            });
          }

          // ======================
          // J1 â€” EDF OFFICIEL SI DISPO
          // ======================
          const j1 = new Date(now);
          j1.setDate(j1.getDate()+1);

          if (edf.tomorrow) {
            days.push({
              date: fmt(j1),
              couleur: edf.tomorrow,
              probabilites: { rouge:0, blanc:0, bleu:0, [edf.tomorrow]:100 },
              fixed: true,
              sources: { edf:true }
            });
          }

          // ======================
          // J2 â†’ J9 â€” ESTIMATION
          // ======================
          for (let i=2;i<=9;i++) {
            const d = new Date(now);
            d.setDate(d.getDate()+i);

            const temp = temps[i] ?? 8;

            let rouge = 15, blanc = 40, bleu = 45;

            if (temp < 3) { blanc+=10; bleu-=5; }
            if (temp < 0) { rouge+=10; bleu-=10; }

            if (tension >= 70) { rouge+=5; blanc+=5; bleu-=10; }

            const total = rouge+blanc+bleu;
            rouge = Math.round(rouge/total*100);
            blanc = Math.round(blanc/total*100);
            bleu = 100-rouge-blanc;

            let couleur = blanc >= bleu ? "blanc" : "bleu";
            if (rouge > blanc && rouge > bleu) couleur = "rouge";

            days.push({
              date: fmt(d),
              couleur,
              probabilites:{rouge,blanc,bleu},
              fixed:false,
              temperature: temp,
              rteConsommation: conso,
              rteTension: tension,
              sources:{historique:true,meteo:true,rte:conso!==null}
            });
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
          fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          EOF

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_scraped.json
          git commit -m "Fix EDF J0/J1 using official scraping" || echo "No changes"
          git push
