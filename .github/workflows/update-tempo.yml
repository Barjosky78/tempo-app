name: Update Tempo + History + Stats + ML (Hourly FINAL FIX)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch EDF Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > edf_tempo.json || echo '{}' > edf_tempo.json

      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      - name: Build tempo.json (J0/J1 SAFE)
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fmt = d => d.toISOString().split("T")[0];

          let edf = {};
          try { edf = JSON.parse(fs.readFileSync("edf_tempo.json","utf8")); } catch {}

          const today = new Date();
          today.setHours(0,0,0,0);

          const days = [];

          // ======================
          // J0 + J1 TOUJOURS CRÉÉS
          // ======================
          for (let i = 0; i <= 1; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);

            let couleur = "bleu";
            let fixed = false;
            let source = "fallback";

            if (i === 0 && edf.today) {
              couleur = edf.today;
              fixed = true;
              source = "edf";
            }

            if (i === 1 && edf.tomorrow) {
              couleur = edf.tomorrow;
              fixed = true;
              source = "edf";
            }

            days.push({
              date: fmt(d),
              couleur,
              probabilites: fixed
                ? { rouge:0, blanc:0, bleu:0, [couleur]:100 }
                : { rouge:0, blanc:0, bleu:100 },
              fixed,
              sources: fixed ? {reel:true} : {fallback:true}
            });
          }

          // ======================
          // J+2 → J+9
          // ======================
          for (let i = 2; i <= 9; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            const dow = d.getDay();

            let rouge = 10, blanc = 30, bleu = 60;

            if (dow === 6) rouge = 0;
            if (dow === 0) { rouge=0; blanc=0; bleu=100; }

            const total = rouge + blanc + bleu;
            rouge = Math.round(rouge / total * 100);
            blanc = Math.round(blanc / total * 100);
            bleu = 100 - rouge - blanc;

            let couleur = "bleu";
            if (rouge > blanc && rouge > bleu) couleur = "rouge";
            else if (blanc >= bleu) couleur = "blanc";

            days.push({
              date: fmt(d),
              couleur,
              probabilites:{rouge,blanc,bleu},
              fixed:false,
              sources:{historique:true}
            });
          }

          fs.writeFileSync("tempo.json", JSON.stringify(days, null, 2));
          fs.writeFileSync("meta.json", JSON.stringify({updatedAt:new Date().toISOString()}, null, 2));
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json edf_tempo.json
          git commit -m "Fix J0/J1 missing days (always generated)" || echo "No changes"
          git push
