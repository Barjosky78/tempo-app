name: Update Tempo + History + Stats (Weekday Recalibrated)

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tempo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1Ô∏è‚É£ Couleurs officielles EDF (J et J+1)
      - name: Fetch Hello Watt
        run: |
          curl -s "https://www.hellowatt.fr/calendrier-tempo-edf-couleur-jour/" > page.html

      # 2Ô∏è‚É£ M√©t√©o (temp√©rature moyenne quotidienne ‚Äì proxy France)
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" > weather.json

      # 3Ô∏è‚É£ Build tempo.json + history.json + stats.json
      - name: Build data files
        run: |
          node <<'EOF'
          const fs = require("fs");

          /* ======================
             LOAD DATA
          ====================== */
          const html = fs.readFileSync("page.html","utf8");
          const weather = JSON.parse(fs.readFileSync("weather.json","utf8"));
          const temps = weather.daily.temperature_2m_mean || [];

          let history = [];
          if (fs.existsSync("history.json")) {
            history = JSON.parse(fs.readFileSync("history.json","utf8"));
          }

          function fmt(d){ return d.toISOString().split("T")[0]; }

          /* ======================
             OFFICIAL COLORS
          ====================== */
          const matches = [...html.matchAll(/Jour (Bleu|Blanc|Rouge)/gi)]
            .map(m=>m[1].toLowerCase());

          const todayColor = matches[0] || "bleu";
          const tomorrowColor = matches[1] || todayColor;

          function fixed(color){
            return {
              rouge: color==="rouge"?100:0,
              blanc: color==="blanc"?100:0,
              bleu:  color==="bleu"?100:0
            };
          }

          /* ======================
             MODEL CONSTANTS
          ====================== */

          // üìä Historique mensuel (4 hivers liss√©s)
          const HISTO_MONTH = {
            11:{rouge:8,  blanc:22, bleu:70},
            12:{rouge:14, blanc:30, bleu:56},
            1:{rouge:20, blanc:34, bleu:46},
            2:{rouge:17, blanc:33, bleu:50},
            3:{rouge:4,  blanc:22, bleu:74}
          };

          // üìÜ Jours de semaine ‚Äì RECALIBR√âS EDF
          const HISTO_WEEKDAY = {
            1:{ rouge:-3, blanc:+6, bleu:-3 }, // Lundi ‚Üí tampon
            2:{ rouge:+4, blanc:+1, bleu:-5 }, // Mardi ‚Üí tension possible
            3:{ rouge:+5, blanc: 0, bleu:-5 }, // Mercredi ‚Üí pic tension
            4:{ rouge:+2, blanc:+3, bleu:-5 }, // Jeudi ‚Üí neutre (blanc fr√©quent)
            5:{ rouge:-4, blanc:+2, bleu:+2 }  // Vendredi ‚Üí rel√¢chement
          };

          /* ======================
             COLD SPAN (froid √©tendu)
          ====================== */
          const coldSpans=[];
          let span=0;
          for(let i=0;i<temps.length;i++){
            if(temps[i]<3) span++; else span=0;
            coldSpans[i]=span;
          }

          /* ======================
             BUILD TEMPO
          ====================== */
          const days=[];
          const today=new Date(); today.setHours(0,0,0,0);

          // üîí Aujourd‚Äôhui
          days.push({
            date:fmt(today),
            couleur:todayColor,
            probabilites:fixed(todayColor),
            fixed:true
          });

          // üîí Demain
          const tomorrow=new Date(today);
          tomorrow.setDate(today.getDate()+1);
          days.push({
            date:fmt(tomorrow),
            couleur:tomorrowColor,
            probabilites:fixed(tomorrowColor),
            fixed:true
          });

          let lastColors=days.map(d=>d.couleur);

          // üîÆ J+2 ‚Üí J+9
          for(let i=2;i<=9;i++){
            const d=new Date(today);
            d.setDate(today.getDate()+i);

            const dow=d.getDay(); // 0=dimanche, 6=samedi
            const month=d.getMonth()+1;
            const temp=temps[i]??10;
            const spanDays=coldSpans[i]||0;

            // üîµ Dimanche = bleu fixe
            if(dow===0){
              days.push({
                date:fmt(d),
                couleur:"bleu",
                probabilites:{rouge:0,blanc:0,bleu:100},
                fixed:true
              });
              lastColors.push("bleu");
              continue;
            }

            // Base mensuelle
            let base=HISTO_MONTH[month]||{rouge:10,blanc:25,bleu:65};
            let rouge=base.rouge, blanc=base.blanc, bleu=base.bleu;

            // Jour de semaine
            if(HISTO_WEEKDAY[dow]){
              rouge+=HISTO_WEEKDAY[dow].rouge;
              blanc+=HISTO_WEEKDAY[dow].blanc;
              bleu +=HISTO_WEEKDAY[dow].bleu;
            }

            // üîÅ S√©quence pr√©c√©dente (SORTIE DE ROUGE R√âALISTE)
            const recent=lastColors.slice(-2);
            if(recent.includes("rouge")){
              rouge-=10;
              blanc+=5;
              bleu +=5;
            }
            if(recent.every(c=>c==="bleu")){
              blanc+=5;
              bleu -=5;
            }

            // üìâ Lissage temporel
            const factor=(10-i)/10;
            rouge=Math.max(2,Math.round(rouge*factor));
            blanc=Math.round(blanc*factor);
            bleu=100-rouge-blanc;

            // ‚ùÑÔ∏è Froid √©tendu
            if(temp<0 && spanDays>=3){
              rouge+=8;
              blanc+=12;
              bleu -=20;
            }else if(temp<3 && spanDays>=3){
              blanc+=15;
              bleu -=15;
            }else if(temp<3){
              blanc+=8;
              bleu -=8;
            }

            // üî¥ Ajustement lundi (froid durable fort)
            if(dow===1 && spanDays>=3 && temp<=0){
              rouge+=5;
              bleu -=5;
            }

            // üü° Samedi = jamais rouge
            if(dow===6){
              blanc+=Math.round(rouge/2);
              bleu +=Math.round(rouge/2);
              rouge=0;

              const t=blanc+bleu;
              blanc=Math.round(blanc/t*100);
              bleu=100-blanc;

              const col=blanc>bleu?"blanc":"bleu";
              days.push({
                date:fmt(d),
                couleur:col,
                probabilites:{rouge:0,blanc,bleu},
                fixed:false
              });
              lastColors.push(col);
              continue;
            }

            // üî¥ Lundi ‚Üí Vendredi normalisation
            const tot=rouge+blanc+bleu;
            rouge=Math.round(rouge/tot*100);
            blanc=Math.round(blanc/tot*100);
            bleu=100-rouge-blanc;

            let col="bleu";
            if(rouge>blanc && rouge>bleu) col="rouge";
            else if(blanc>bleu) col="blanc";

            days.push({
              date:fmt(d),
              couleur:col,
              probabilites:{rouge,blanc,bleu},
              fixed:false
            });

            lastColors.push(col);
          }

          fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));

          /* ======================
             HISTORY UPDATE
          ====================== */
          const todayStr=fmt(today);

          // Add predictions
          days.forEach((d,i)=>{
            if(i>=2){
              const exists=history.find(h=>h.date===d.date && h.predictedOn===todayStr);
              if(!exists){
                history.push({
                  date:d.date,
                  predictedOn:todayStr,
                  horizon:i,
                  predictedColor:d.couleur,
                  probabilites:d.probabilites,
                  realColor:null,
                  result:null
                });
              }
            }
          });

          // Verdict function
          function verdict(entry){
            const sorted=Object.entries(entry.probabilites)
              .sort((a,b)=>b[1]-a[1]);
            if(sorted[0][0]===entry.realColor) return "correct";
            if(sorted[1][0]===entry.realColor) return "partial";
            return "wrong";
          }

          // Resolve real results
          history.forEach(h=>{
            if(!h.realColor && h.date===todayStr){
              h.realColor=todayColor;
              h.result=verdict(h);
            }
          });

          fs.writeFileSync("history.json",JSON.stringify(history,null,2));

          /* ======================
             STATS
          ====================== */
          const resolved=history.filter(h=>h.realColor);
          const stats={
            total:resolved.length,
            correct:resolved.filter(h=>h.result==="correct").length,
            partial:resolved.filter(h=>h.result==="partial").length,
            wrong:resolved.filter(h=>h.result==="wrong").length
          };
          stats.accuracy=stats.total
            ?Math.round(stats.correct/stats.total*100):0;
          stats.accuracyWithPartial=stats.total
            ?Math.round((stats.correct+stats.partial)/stats.total*100):0;

          fs.writeFileSync("stats.json",JSON.stringify(stats,null,2));
          EOF

      # 4Ô∏è‚É£ Commit & push
      - name: Commit and push files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json history.json stats.json
          git commit -m "Recalibrate weekday logic (EDF-like)" || echo "No changes"
          git push
