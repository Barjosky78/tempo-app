name: Update Tempo + History + Stats + ML (Hourly FINAL MULTI-SOURCE INLINE)

concurrency:
  group: pages
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v3

      # ======================
      # NODE (SCRAPING + BUILD)
      # ======================
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      # ======================
      # FETCH API TEMPO
      # ======================
      - name: Fetch API Tempo
        run: |
          curl -s https://www.api-couleur-tempo.fr/api > api_tempo.json || echo '{}' > api_tempo.json

      # ======================
      # FETCH WEATHER
      # ======================
      - name: Fetch Weather
        run: |
          curl -s "https://api.open-meteo.com/v1/forecast?latitude=48.85&longitude=2.35&daily=temperature_2m_mean&forecast_days=10&timezone=Europe%2FParis" \
          | jq . > weather.json || echo '{}' > weather.json

      # ======================
      # FETCH RTE
      # ======================
      - name: Fetch RTE
        run: |
          curl -s "https://odre.opendatasoft.com/api/records/1.0/search/?dataset=eco2mix-national-cons-def&rows=1&sort=-date_heure" \
          | jq . > rte.json || echo '{}' > rte.json

      # ======================
      # BUILD tempo.json (MULTI-SOURCE INLINE)
      # ======================
      - name: Build tempo.json
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fetch = (...a)=>import("node-fetch").then(({default:f})=>f(...a));
          const fmt = d => d.toISOString().split("T")[0];

          const COLORS = ["bleu","blanc","rouge"];
          const today = new Date();
          today.setHours(0,0,0,0);

          /* ======================
             LOAD SOURCES
          ====================== */
          const api = JSON.parse(fs.readFileSync("api_tempo.json","utf8") || "{}");
          const weather = JSON.parse(fs.readFileSync("weather.json","utf8") || "{}");
          const rte = JSON.parse(fs.readFileSync("rte.json","utf8") || "{}");

          let apiToday = api.today ?? api.aujourd_hui ?? null;
          let apiTomorrow = api.tomorrow ?? api.demain ?? null;
          if (typeof apiToday === "string") apiToday = apiToday.toLowerCase();
          if (typeof apiTomorrow === "string") apiTomorrow = apiTomorrow.toLowerCase();

          /* ======================
             SCRAPE EDF
          ====================== */
          async function scrape(url) {
            try {
              const html = await (await fetch(url)).text();
              const grab = label => {
                const m = html.match(new RegExp(label+"[\\s\\S]*?(Bleu|Blanc|Rouge)","i"));
                return m ? m[1].toLowerCase() : null;
              };
              return {
                today: grab("Aujourd’hui|Aujourd'hui"),
                tomorrow: grab("Demain")
              };
            } catch {
              return {};
            }
          }

          (async()=>{
            const edf = await scrape("https://particulier.edf.fr/fr/accueil/gestion-contrat/options/tempo.html");
            const hw  = await scrape("https://www.hellowatt.fr/edf/tempo");

            const pick = (...vals) => vals.find(v => COLORS.includes(v)) || null;

            const j0 = pick(edf.today, hw.today, apiToday);
            const j1 = pick(edf.tomorrow, hw.tomorrow, apiTomorrow);

            const days = [];

            /* ======================
               J0
            ====================== */
            days.push({
              date: fmt(today),
              couleur: j0 || "bleu",
              probabilites: { rouge:0, blanc:0, bleu:0, [j0||"bleu"]:100 },
              fixed: true,
              sources:{
                edf_site: !!edf.today,
                hellowatt: !!hw.today,
                api: !!apiToday
              }
            });

            /* ======================
               J1
            ====================== */
            const tmr = new Date(today);
            tmr.setDate(today.getDate()+1);

            if (j1) {
              days.push({
                date: fmt(tmr),
                couleur: j1,
                probabilites: { rouge:0, blanc:0, bleu:0, [j1]:100 },
                fixed: true,
                sources:{
                  edf_site: !!edf.tomorrow,
                  hellowatt: !!hw.tomorrow,
                  api: !!apiTomorrow
                }
              });
            }

            /* ======================
               J2 → J9 (inchangé)
            ====================== */
            const temps = weather.daily?.temperature_2m_mean || [];
            let consommation = rte.records?.[0]?.fields?.consommation ?? null;
            let tension = consommation < 45000 ? 50 : consommation < 55000 ? 60 : consommation < 65000 ? 70 : 80;

            for (let i=2;i<=9;i++) {
              const d = new Date(today);
              d.setDate(today.getDate()+i);
              const temp = temps[i] ?? 8;

              let rouge=10, blanc=30, bleu=60;
              if (temp < 3) blanc+=10;
              if (temp < 0) rouge+=8;

              const total=rouge+blanc+bleu;
              rouge=Math.round(rouge/total*100);
              blanc=Math.round(blanc/total*100);
              bleu=100-rouge-blanc;

              let couleur = bleu>=blanc?"bleu":"blanc";
              if (rouge>blanc&&rouge>bleu) couleur="rouge";

              days.push({
                date: fmt(d),
                couleur,
                probabilites:{rouge,blanc,bleu},
                fixed:false,
                temperature:temp,
                rteConsommation:consommation,
                rteTension:tension,
                sources:{historique:true,meteo:true,rte:!!consommation}
              });
            }

            fs.writeFileSync("tempo.json",JSON.stringify(days,null,2));
            fs.writeFileSync("meta.json",JSON.stringify({updatedAt:new Date().toISOString()},null,2));
          })();
          EOF

      # ======================
      # COMMIT
      # ======================
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tempo.json meta.json api_tempo.json
          git commit -m "Tempo update (EDF + HelloWatt + API, inline build)" || echo "No changes"
          git push
