name: Build real Tempo history (RTE official)

on:
  workflow_dispatch:
  schedule:
    - cron: '15 3 * * 1'   # Lundi 03:15 UTC (1 fois par semaine suffit)

permissions:
  contents: write

jobs:
  build-history:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ======================
      # BUILD HISTORY REAL TEMPO
      # ======================
      - name: Build real Tempo history from RTE (SAFE)
        run: |
          node <<'EOF'
          const fs = require("fs");
          const https = require("https");

          console.log("ðŸ“¦ Building real Tempo history from RTE official repo");

          const YEARS = [
            "2016_2017",
            "2017_2018",
            "2018_2019",
            "2019_2020",
            "2020_2021",
            "2021_2022",
            "2022_2023",
            "2023_2024",
            "2024_2025"
          ];

          const BASE_URL =
            "https://raw.githubusercontent.com/jbromain/rte-tempo/master/data";

          const OUTPUT_FILE = "history_real_tempo.json";
          const results = [];

          function fetch(url) {
            return new Promise(resolve => {
              https.get(url, res => {
                if (res.statusCode !== 200) {
                  console.warn("âš ï¸ HTTP", res.statusCode, url);
                  resolve(null);
                  return;
                }
                let data = "";
                res.on("data", c => data += c);
                res.on("end", () => resolve(data));
              }).on("error", () => {
                console.warn("âš ï¸ Network error:", url);
                resolve(null);
              });
            });
          }

          (async () => {
            for (const year of YEARS) {
              const url = `${BASE_URL}/tempo_${year}.json`;
              console.log("â¬‡ï¸ Fetch", url);

              const raw = await fetch(url);
              if (!raw) {
                console.warn("âš ï¸ Skip year", year);
                continue;
              }

              let json;
              try {
                json = JSON.parse(raw);
              } catch {
                console.warn("âš ï¸ Invalid JSON", year);
                continue;
              }

              if (!Array.isArray(json)) {
                console.warn("âš ï¸ Unexpected format", year);
                continue;
              }

              json.forEach(d => {
                if (!d.date || !d.color) return;
                results.push({
                  date: d.date,
                  realColor: d.color.toLowerCase()
                });
              });

              console.log("âœ… Loaded", year, json.length, "days");
            }

            results.sort((a, b) => a.date.localeCompare(b.date));

            fs.writeFileSync(
              OUTPUT_FILE,
              JSON.stringify(results, null, 2),
              "utf8"
            );

            console.log("ðŸŽ‰ history_real_tempo.json generated");
            console.log("ðŸ“… Total days:", results.length);
          })();
          EOF

      # ======================
      # COMMIT IF CHANGED
      # ======================
      - name: Commit history_real_tempo.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add history_real_tempo.json
          git commit -m "Update real Tempo history (RTE official)" || echo "No changes"
          git push
