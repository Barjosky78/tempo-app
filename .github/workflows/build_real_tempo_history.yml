- name: Build real Tempo history (official RTE repo)
  run: |
    node <<'EOF'
    const fs = require("fs");
    const https = require("https");

    console.log("ðŸ“¦ Build real Tempo history from official RTE repository");

    // ======================
    // ANNÃ‰ES DISPONIBLES
    // ======================
    const YEARS = [
      "2016_2017",
      "2017_2018",
      "2018_2019",
      "2019_2020",
      "2020_2021",
      "2021_2022",
      "2022_2023",
      "2023_2024",
      "2024_2025"
    ];

    const BASE_URL =
      "https://raw.githubusercontent.com/jbromain/rte-tempo/master/data";

    const OUTPUT_PATH = "history_real_tempo.json";
    const output = [];

    // ======================
    // FETCH UTIL
    // ======================
    function fetch(url) {
      return new Promise((resolve, reject) => {
        https
          .get(url, res => {
            if (res.statusCode !== 200) {
              reject(new Error("HTTP " + res.statusCode));
              return;
            }

            let data = "";
            res.on("data", chunk => (data += chunk));
            res.on("end", () => resolve(data));
          })
          .on("error", reject);
      });
    }

    // ======================
    // MAIN
    // ======================
    (async () => {
      for (const year of YEARS) {
        const url = `${BASE_URL}/tempo_${year}.json`;

        try {
          console.log("â¬‡ï¸ Fetch:", url);
          const raw = await fetch(url);

          let json;
          try {
            json = JSON.parse(raw);
          } catch {
            console.warn("âš ï¸ JSON invalide pour", year);
            continue;
          }

          if (!Array.isArray(json)) {
            console.warn("âš ï¸ Format inattendu pour", year);
            continue;
          }

          json.forEach(d => {
            if (!d.date || !d.color) return;

            output.push({
              date: d.date,
              realColor: d.color.toLowerCase()
            });
          });

          console.log("âœ… AnnÃ©e chargÃ©e:", year, "-", json.length, "jours");
        } catch (err) {
          console.warn("âš ï¸ AnnÃ©e ignorÃ©e:", year);
        }
      }

      // ======================
      // TRI & SAUVEGARDE
      // ======================
      output.sort((a, b) => a.date.localeCompare(b.date));

      fs.writeFileSync(
        OUTPUT_PATH,
        JSON.stringify(output, null, 2),
        "utf8"
      );

      console.log("ðŸŽ‰ Historique Tempo rÃ©el gÃ©nÃ©rÃ©");
      console.log("ðŸ“… Jours total:", output.length);
      console.log("ðŸ’¾ Fichier:", OUTPUT_PATH);
    })();
    EOF
