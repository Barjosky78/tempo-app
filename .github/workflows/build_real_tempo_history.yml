name: Build REAL Tempo History (RTE Official)

on:
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *'   # Tous les jours Ã  02h30 UTC

permissions:
  contents: write

jobs:
  build-history:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build real Tempo history from RTE
        run: |
          node <<'EOF'
          const fs = require("fs");
          const https = require("https");

          const OUTPUT = "history_real_tempo.json";

          // ======================
          // RTE TEMPO SOURCE
          // ======================
          const url = "https://odre.opendatasoft.com/api/records/1.0/search/?" +
            "dataset=tempo-jours-rouges-blancs-bleus&" +
            "rows=5000&sort=date";

          function fetch(url) {
            return new Promise((resolve, reject) => {
              https.get(url, res => {
                let data = "";
                res.on("data", c => data += c);
                res.on("end", () => resolve(JSON.parse(data)));
              }).on("error", reject);
            });
          }

          (async () => {
            console.log("ðŸ“¥ Fetching real Tempo history from RTE...");
            const json = await fetch(url);

            if (!json.records) {
              throw new Error("RTE data invalid");
            }

            const history = json.records
              .map(r => ({
                date: r.fields.date,
                color: r.fields.couleur
              }))
              .filter(d => d.color)
              .sort((a, b) => a.date.localeCompare(b.date));

            fs.writeFileSync(OUTPUT, JSON.stringify(history, null, 2));
            console.log(`âœ… ${history.length} real Tempo days saved`);
          })();
          EOF

      - name: Commit history_real_tempo.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add history_real_tempo.json
          git commit -m "Update REAL Tempo history from RTE" || echo "No changes"
          git push
