name: "üîß Rebuild ML (historique complet + entra√Ænement)"

# Workflow √† ex√©cuter UNE SEULE FOIS pour reconstruire l'historique avec les jours bleu
# Apr√®s ex√©cution r√©ussie, vous pouvez le supprimer ou le garder pour r√©-entra√Æner plus tard

on:
  workflow_dispatch:  # D√©clenchement manuel uniquement

permissions:
  contents: write

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # CHECKOUT
      # ======================
      - uses: actions/checkout@v3

      # ======================
      # PYTHON
      # ======================
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          pip install pandas scikit-learn joblib requests

      # ======================
      # √âTAPE 1 : R√©cup√©rer l'historique COMPLET depuis l'API EDF
      # ======================
      - name: "üì• Step 1 - Rebuild history_real_tempo.json (avec jours bleu)"
        run: |
          python3 scripts/build_history_from_tempo_api.py

          echo ""
          echo "=== V√©rification ==="
          python3 -c "
          import json
          from collections import Counter
          data = json.load(open('history_real_tempo.json'))
          colors = Counter(d['color'] for d in data)
          print(f'Total: {len(data)} jours')
          print(f'Bleu:  {colors.get(\"bleu\", 0)}')
          print(f'Blanc: {colors.get(\"blanc\", 0)}')
          print(f'Rouge: {colors.get(\"rouge\", 0)}')
          if colors.get('bleu', 0) == 0:
              raise SystemExit('‚ùå Toujours pas de jours bleu !')
          print('‚úÖ Jours bleu pr√©sents !')
          "

      # ======================
      # √âTAPE 2 : R√©cup√©rer la m√©t√©o historique (enrichir le dataset)
      # ======================
      - name: "üå¶Ô∏è Step 2 - Update weather history"
        run: |
          python3 scripts/build_weather_history.py || echo "‚ö†Ô∏è Weather update skipped"

      # ======================
      # √âTAPE 3 : R√©cup√©rer l'historique RTE
      # ======================
      - name: "‚ö° Step 3 - Update RTE history"
        run: |
          python3 scripts/build_rte_history.py || echo "‚ö†Ô∏è RTE update skipped"

      # ======================
      # √âTAPE 4 : Reconstruire le dataset ML (3 couleurs)
      # ======================
      - name: "üìä Step 4 - Rebuild ML dataset (bleu + blanc + rouge)"
        run: |
          python3 scripts/build_ml_dataset.py

          echo ""
          echo "=== V√©rification dataset ==="
          python3 -c "
          import json
          from collections import Counter
          data = json.load(open('ML/ml_dataset.json'))
          colors = Counter(d['color'] for d in data)
          print(f'Dataset: {len(data)} √©chantillons')
          for c in ['bleu', 'blanc', 'rouge']:
              n = colors.get(c, 0)
              pct = n / len(data) * 100 if data else 0
              print(f'  {c}: {n} ({pct:.1f}%)')
          if colors.get('bleu', 0) < 50:
              print('‚ö†Ô∏è Peu de jours bleu, les pr√©dictions pourraient √™tre impr√©cises')
          "

      # ======================
      # √âTAPE 5 : Entra√Æner le mod√®le ML
      # ======================
      - name: "üß† Step 5 - Train ML model"
        run: |
          python3 ML/train_ml.py

      # ======================
      # √âTAPE 6 : V√©rifier le mod√®le
      # ======================
      - name: "‚úÖ Step 6 - Verify model & run predictions"
        run: |
          python3 -c "
          import joblib
          bundle = joblib.load('ML/ml_model.pkl')
          classes = list(bundle['label_encoder'].classes_)
          print(f'Mod√®le: {bundle.get(\"model_type\", \"?\")}')
          print(f'Classes: {classes}')
          print(f'Features: {len(bundle[\"features\"])}')
          if 'bleu' not in classes:
              raise SystemExit('‚ùå Le mod√®le ne conna√Æt toujours pas bleu !')
          print('‚úÖ Le mod√®le conna√Æt les 3 couleurs !')
          "

          # Lancer les pr√©dictions si tempo.json existe
          if [ -f tempo.json ]; then
            python3 ML/predict_ml.py
          fi

      # ======================
      # COMMIT TOUT
      # ======================
      - name: "üíæ Commit all rebuilt files"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            history_real_tempo.json \
            weather_history.json \
            rte_history.json \
            ML/ml_dataset.json \
            ML/ml_model.pkl \
            ML/ml_predictions.json
          git diff --cached --quiet && echo "No changes" || \
            (git commit -m "üß† Rebuild ML complet ‚Äî historique 3 couleurs + entra√Ænement" && git push)
          
          echo ""
          echo "========================================="
          echo "üéâ TERMIN√â !"
          echo "========================================="
          echo "L'historique contient maintenant les 3 couleurs."
          echo "Le mod√®le ML est entra√Æn√© avec bleu + blanc + rouge."
          echo ""
          echo "Le workflow quotidien 'Update Tempo' devrait"
          echo "maintenant g√©n√©rer des pr√©dictions vari√©es."
          echo "========================================="
